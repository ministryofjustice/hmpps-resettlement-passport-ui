{% extends "../partials/layout.njk" %}
{% set pathwayName = "BCST2 Form" %}
{% set pageTitle = applicationName + " - " + pathwayName %}
{% set mainClasses = "app-container govuk-body" %}
{% from "../macros/radio-with-address.njk" import radioWithAddress %}
{% from "../macros/radio.njk" import radio %}
{% from "../macros/longText.njk" import longText %}
{% from "../macros/dropDown.njk" import dropDown %}
{% from "../macros/assessmentSummary.njk" import assessmentSummary %}
{% from "../macros/checkAnswers.njk" import checkAnswers %}
{% from "../macros/listOfPeople.njk" import listOfPeople %}
{% from "../macros/checkbox.njk" import checkbox %}

{% block header %}
  {% if feComponents.header %}
    {{ feComponents.header | safe }}
  {% else %}
    {% include "./header.njk" %}
  {% endif %}
  <div class="govuk-width-container">
    {{ govukPhaseBanner({
      tag: {
        text: phaseName
      },
      html: feedbackText
    }) }}
  </div>
{% endblock %}

{% block content %}
  <main class="govuk-!-padding-top-8" id="main-content" role="main">
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-three-quarters">
        <a class="govuk-link govuk-link--no-visited-state" href="/assessment-task-list/?prisonerNumber={{ prisonerData.personalDetails.prisonerNumber }}">Back</a>
        
        {% if not assessmentPage.error %}
          {% if assessmentPage.id === "CHECK_ANSWERS" %}
            <h1 class="govuk-heading-l govuk-!-margin-top-6 govuk-!-margin-bottom-3">Check your answers before submitting the {{ (pathway | getEnumValue).name }} assessment</h1>
          {% else %}
            <h1 class="govuk-heading-l govuk-!-margin-top-6 govuk-!-margin-bottom-3">{{ assessmentPage.questionsAndAnswers[0].question.title }}</h1>
          {% endif %}
          <form
            {% if assessmentPage.id == 'CHECK_ANSWERS' %}
              action="/BCST2/pathway/{{ pathway }}/complete?prisonerNumber={{ prisonerData.personalDetails.prisonerNumber }}"
            {% else %}
              action="/BCST2-next-page/?prisonerNumber={{ prisonerData.personalDetails.prisonerNumber }}"
            {% endif %}
            method="post"
          >

            {% if assessmentPage.id === "CHECK_ANSWERS" %}
              {{ checkAnswers(allQuestionsAndAnswers, pathway, prisonerData.personalDetails.prisonerNumber) }}
            {% else %}
              {% if assessmentPage.id === "ASSESSMENT_SUMMARY" %}
                {{ assessmentSummary(pathway) }}
              {% endif %}

              {% for currentQuestionAndAnswer in assessmentPage.questionsAndAnswers %}

                {# get answer to current question #}
                {% set existingAnswer = currentQuestionAndAnswer | getAnswerToCurrentQuestion(allQuestionsAndAnswers) %}
                {% set currentIndex = loop.index %}
                {% if currentIndex == 1 %}
                  {% set isFirstQuestionOnPage = true %}
                {% endif %}

                {% if currentQuestionAndAnswer.question.type === 'RADIO_WITH_ADDRESS' %}
                  {# get the next question and answer (ADDRESS) item in the array #}
                  {% set nextQuestionAndAnswer = assessmentPage.questionsAndAnswers[currentIndex] %}
                  {% set nextQuestionExistingAnswer = nextQuestionAndAnswer | getAnswerToCurrentQuestion(allQuestionsAndAnswers) %}
                  {{ radioWithAddress(currentQuestionAndAnswer, existingAnswer, isFirstQuestionOnPage, nextQuestionAndAnswer, nextQuestionExistingAnswer) }}
                {% elif currentQuestionAndAnswer.question.type === 'RADIO' %}
                  {{ radio(currentQuestionAndAnswer, existingAnswer, isFirstQuestionOnPage) }}
                {% elif currentQuestionAndAnswer.question.type === 'LONG_TEXT' %}
                  {{ longText(currentQuestionAndAnswer, existingAnswer, isFirstQuestionOnPage) }}
                {% elif currentQuestionAndAnswer.question.type === 'DROPDOWN' %}
                  {{ dropDown(currentQuestionAndAnswer, existingAnswer, isFirstQuestionOnPage) }}
                {% elif currentQuestionAndAnswer.question.type === 'CHECKBOX' %}
                  {{ checkbox(currentQuestionAndAnswer, existingAnswer, isFirstQuestionOnPage) }}
                {% elif currentQuestionAndAnswer.question.type === 'LIST_OF_PEOPLE' %}
                  {{ listOfPeople(currentQuestionAndAnswer, existingAnswer, isFirstQuestionOnPage) }}
                {% elif not currentQuestionAndAnswer.question.type === 'RADIO_WITH_ADDRESS' %}
                  <p class="govuk-error-message govuk-!-padding-top-6">There was a problem getting the next question.<br /> Please try again. <a class="govuk-link" href="{{ feedbackUrl }}">Contact us</a> if the problem still occurs</p>
                {% endif %}
              {% endfor %}
            {% endif %}
            
            <input type="hidden" name="pageTitle" value="{{ assessmentPage.title }}"/>
            <input type="hidden" name="pathway" value="{{ pathway }}"/>
            <input type="hidden" name="currentPageId" value="{{ assessmentPage.id }}"/>
            <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>
            <button class="govuk-button govuk-!-margin-bottom-4 govuk-!-margin-top-8" type="submit">
              {% if assessmentPage.id === 'CHECK_ANSWERS' %}
                Confirm
              {% else %}
                Continue
              {% endif %}
            </button>
          </form>
        {% else %}
          <h1 class="govuk-heading-l govuk-!-margin-top-6 govuk-!-margin-bottom-3">Something went wrong</h1>
          <p>There was a problem loading the assessment. Please try again. <a class="govuk-link" href="{{ feedbackUrl }}">Contact us</a> if the problem still occurs</p>
        {% endif %}
      </div>
    </div>
  </main>
 
{% endblock %}